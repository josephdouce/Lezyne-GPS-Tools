<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TCX to LZR Converter</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>TCX to LZR Converter</h1>
  <label for="file-input" class="custom-file-upload" id="file-label">Choose TCX File</label><br>
  <input id="file-input" type="file" accept=".tcx" style="display: none;" /><br>
    <button id="convert-btn" disabled>Convert</button>
    <p id="status">Loading Pyodide...</p>
  </div>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <script>
    document.getElementById("file-input").addEventListener("change", function () {
  const file = this.files[0];
  const label = document.getElementById("file-label");
  label.textContent = file ? file.name : "Choose TCX File";
});

    let pyodide;

    async function loadPythonScriptFromFile(url) {
      const response = await fetch(url);
      const pythonCode = await response.text();
      await pyodide.runPythonAsync(pythonCode);
    }

    (async () => {
      pyodide = await loadPyodide();
      await pyodide.loadPackage(["micropip"]);
      await loadPythonScriptFromFile("tcx2lzr.py");
      document.getElementById("status").textContent = "Ready";
      document.getElementById("convert-btn").disabled = false;
    })();

    document.getElementById("convert-btn").onclick = async () => {
      const file = document.getElementById("file-input").files[0];
      if (!file) return alert("Please select a TCX file.");

      document.getElementById("status").textContent = "Converting…";
      const arr = new Uint8Array(await file.arrayBuffer());
      pyodide.globals.set("input_bytes", arr);

      try {
        const resultBytes = await pyodide.runPythonAsync(`
import js
js.Function("return new Uint8Array(arguments[0]);")(convert_file(input_bytes))
        `);
        const blob = new Blob([resultBytes], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = file.name.replace(/\.tcx$/i, ".lzr");
        a.click();
        document.getElementById("status").textContent = "✅ Done!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "❌ Error: " + err.message;
      }
    };
  </script>
</body>
</html>
